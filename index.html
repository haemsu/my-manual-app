<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ê¹ƒí—ˆë¸Œ ì—°ë™ ê°œì¸ ë§¤ë‰´ì–¼</title>
<style>
  html, body { margin:0; padding:0; height:100%; font-family: 'Malgun Gothic', ë‹ì›€, Arial, sans-serif; }
  #loginOverlay {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.75);
    display: flex; justify-content: center; align-items: center;
    flex-direction: column; color: #fff;
    z-index: 9999;
  }
  #loginOverlay input {
    font-size: 1rem; padding: 8px; width: 320px; border-radius: 4px; border: none;
    margin-top: 12px;
  }
  #loginOverlay button {
    margin-top: 12px; padding: 8px 16px; font-size: 1rem;
    border:none; border-radius:4px; cursor: pointer;
    background-color: #0066ff; color: white;
  }
  #loginOverlay a {
    margin-top: 8px; color: #8cf; text-decoration: underline;
  }
  #loginError {
    margin-top: 8px; color: #f88;
  }

  #app {
    display: none; height: 100vh; display: flex;
    background: #f9f9f9;
  }
  #sidebar {
    width: 300px; border-right: 1px solid #ccc;
    box-sizing: border-box; padding: 12px;
    background: white;
    display: flex; flex-direction: column;
  }
  #sidebar h2 {
    margin: 0 0 12px 0; font-size: 1.3rem;
  }
  #pageList {
    list-style: none; padding: 0; margin: 0; flex: 1;
    overflow-y: auto;
    border: 1px solid #ccc; border-radius: 6px;
  }
  #pageList li {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 10px; border-bottom: 1px solid #eee;
    cursor: pointer;
  }
  #pageList li.selected {
    background-color: #d0e7ff;
    font-weight: bold;
  }
  #pageList li input.edit-name {
    flex: 1;
    font-size: 1rem;
    border: 1px solid #888;
    border-radius: 4px;
    padding: 4px 6px;
  }
  #pageList li button {
    background: none; border: none; color: #888; font-size: 1.1rem;
    cursor: pointer; padding: 0 6px;
  }
  #addPageBtn {
    margin-top: 12px; padding: 8px;
    font-size: 1rem; border-radius: 4px;
    border: none; cursor: pointer;
    background-color: #0066ff; color: white;
  }

  #content {
    flex: 1; padding: 12px;
    display: flex; flex-direction: column;
  }
  #contentHeader {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 12px;
  }
  #contentHeader h2 {
    margin: 0;
  }
  #logoutBtn {
    background-color: #f44336;
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
  }
  #editor {
    flex: 1;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 12px;
    font-size: 1rem;
    line-height: 1.4;
    resize: none;
    outline: none;
    font-family: 'Malgun Gothic', ë‹ì›€, Arial, sans-serif;
    background-color: white;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-word;
  }
</style>
</head>
<body>

<div id="loginOverlay">
  <div>GitHub Personal Access Tokenì„ ì…ë ¥í•˜ì„¸ìš”</div>
  <input type="password" id="tokenInput" placeholder="í† í° ì…ë ¥" autocomplete="off" spellcheck="false" />
  <button id="loginBtn">ë¡œê·¸ì¸</button>
  <a href="https://github.com/settings/tokens" target="_blank" rel="noopener">í† í° ìƒì„±í•˜ëŸ¬ ê°€ê¸°</a>
  <div id="loginError"></div>
</div>

<div id="app">
  <div id="sidebar">
    <h2>ë§¤ë‰´ì–¼ í•­ëª©</h2>
    <ul id="pageList"></ul>
    <button id="addPageBtn">+ ìƒˆ í•­ëª© ì¶”ê°€</button>
  </div>
  <div id="content">
    <div id="contentHeader">
      <h2 id="pageTitle"></h2>
      <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    <div id="editor" contenteditable="true" spellcheck="false" aria-label="ë§¤ë‰´ì–¼ ë‚´ìš© í¸ì§‘ ì˜ì—­"></div>
  </div>
</div>

<script>
(() => {
  // GitHub ì €ì¥ì†Œ ì„¤ì •
  const OWNER = 'haemsu';
  const REPO = 'my-manual-app';
  const FILEPATH = 'data/manual.json';
  const BRANCH = 'main';

  // DOM ìš”ì†Œ
  const loginOverlay = document.getElementById('loginOverlay');
  const tokenInput = document.getElementById('tokenInput');
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');
  const app = document.getElementById('app');
  const pageList = document.getElementById('pageList');
  const addPageBtn = document.getElementById('addPageBtn');
  const pageTitle = document.getElementById('pageTitle');
  const editor = document.getElementById('editor');
  const logoutBtn = document.getElementById('logoutBtn');

  let token = '';
  let fileSha = null;
  let pages = {};
  let currentKey = null;

  // GitHub API í˜¸ì¶œ í•¨ìˆ˜
  async function githubApi(path, method = 'GET', body = null) {
    const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`, {
      method,
      headers: {
        Authorization: `token ${token}`,
        Accept: 'application/vnd.github+json',
      },
      body: body ? JSON.stringify(body) : null,
    });
    if (!res.ok) {
      const errData = await res.json().catch(() => ({}));
      const msg = errData.message || `${res.status} ${res.statusText}`;
      throw new Error(msg);
    }
    return res.json();
  }

  // base64 ë””ì½”ë“œ
  function b64DecodeUnicode(str) {
    return decodeURIComponent(
      Array.prototype.map.call(atob(str), c => {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join('')
    );
  }

  // base64 ì¸ì½”ë“œ (utf-8 ì§€ì›)
  function b64EncodeUnicode(str) {
    return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
      (match, p1) => String.fromCharCode('0x' + p1)));
  }

  // ê¹ƒí—ˆë¸Œì—ì„œ manual.json ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadManual() {
    const data = await githubApi(FILEPATH);
    fileSha = data.sha;
    const contentStr = b64DecodeUnicode(data.content.replace(/\n/g, ''));
    pages = JSON.parse(contentStr);
    if (!pages || typeof pages !== 'object' || Object.keys(pages).length === 0) {
      pages = { 'ì˜ˆì‹œ í•­ëª©': 'ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”.' };
    }
    currentKey = Object.keys(pages)[0];
    renderPageList();
    renderCurrentPage();
    loginOverlay.style.display = 'none';
    app.style.display = 'flex';
  }

  // í˜ì´ì§€ ëª©ë¡ ë Œë”ë§
  function renderPageList() {
    pageList.innerHTML = '';
    Object.keys(pages).forEach(key => {
      const li = document.createElement('li');
      li.className = (key === currentKey) ? 'selected' : '';
      
      // ì´ë¦„ ìˆ˜ì • input
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = key;
      nameInput.className = 'edit-name';
      nameInput.title = 'í´ë¦­ ì‹œ ì´ë¦„ ìˆ˜ì •';
      nameInput.addEventListener('click', e => e.stopPropagation());
      
      // ì´ë¦„ ë³€ê²½ ì²˜ë¦¬ (ì—”í„° ë˜ëŠ” í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ)
      function finishEdit() {
        const newName = nameInput.value.trim();
        if (!newName) {
          alert('ì´ë¦„ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          nameInput.value = key;
          return;
        }
        if (newName !== key) {
          if (pages[newName]) {
            alert('ì´ë¯¸ ê°™ì€ ì´ë¦„ì˜ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.');
            nameInput.value = key;
            return;
          }
          // ì´ë¦„ ë³€ê²½: ê°ì²´ í‚¤ êµì²´
          pages[newName] = pages[key];
          delete pages[key];
          if (currentKey === key) currentKey = newName;
          saveManual();
          renderPageList();
          renderCurrentPage();
        }
      }
      nameInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          nameInput.blur();
        }
      });
      nameInput.addEventListener('blur', finishEdit);
      
      li.appendChild(nameInput);

      // ì‚­ì œ ë²„íŠ¼
      const delBtn = document.createElement('button');
      delBtn.textContent = 'ğŸ—‘';
      delBtn.title = 'ì‚­ì œ';
      delBtn.addEventListener('click', e => {
        e.stopPropagation();
        if (confirm(`"${key}" í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          delete pages[key];
          if (currentKey === key) {
            const keys = Object.keys(pages);
            currentKey = keys.length ? keys[0] : null;
          }
          saveManual();
          renderPageList();
          renderCurrentPage();
        }
      });
      li.appendChild(delBtn);

      // í´ë¦­ ì‹œ ì„ íƒ
      li.addEventListener('click', () => {
        if (currentKey === key) return;
        currentKey = key;
        renderPageList();
        renderCurrentPage();
      });

      pageList.appendChild(li);
    });
  }

  // í˜„ì¬ í˜ì´ì§€ ë‚´ìš© ë Œë”ë§
  function renderCurrentPage() {
    if (!currentKey) {
      pageTitle.textContent = '(ì„ íƒëœ í•­ëª© ì—†ìŒ)';
      editor.textContent = '';
      editor.setAttribute('contenteditable', 'false');
      return;
    }
    pageTitle.textContent = currentKey;
    editor.textContent = pages[currentKey] || '';
    editor.setAttribute('contenteditable', 'true');
    editor.focus();
  }

  // ì €ì¥ì†Œì— manual.json ìë™ ì €ì¥
  let saveTimeout = null;
  function scheduleSave() {
    if (saveTimeout) clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
      saveManual();
    }, 600); // 0.6ì´ˆ ë””ë°”ìš´ìŠ¤
  }

  async function saveManual() {
    if (!currentKey) return;
    pages[currentKey] = editor.textContent;
    const jsonStr = JSON.stringify(pages, null, 2);
    const contentEncoded = b64EncodeUnicode(jsonStr);

    try {
      const res = await githubApi(FILEPATH, 'PUT', {
        message: `[auto] Update ${currentKey}`,
        content: contentEncoded,
        sha: fileSha,
        branch: BRANCH,
      });
      fileSha = res.content.sha;
      console.log('ì €ì¥ ì™„ë£Œ:', currentKey);
    } catch (err) {
      alert('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
    }
  }

  // í¸ì§‘ ë‚´ìš© ë³€ê²½ì‹œ ìë™ ì €ì¥ ì˜ˆì•½
  editor.addEventListener('input', () => {
    if (!currentKey) return;
    pages[currentKey] = editor.textContent;
    scheduleSave();
  });

  // ìƒˆ í•­ëª© ì¶”ê°€
  addPageBtn.addEventListener('click', () => {
    let newName = prompt('ìƒˆ í•­ëª© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
    if (!newName) return;
    newName = newName.trim();
    if (!newName) {
      alert('ì´ë¦„ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    if (pages[newName]) {
      alert('ì´ë¯¸ ê°™ì€ ì´ë¦„ì˜ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.');
      return;
    }
    pages[newName] = '';
    currentKey = newName;
    renderPageList();
    renderCurrentPage();
    saveManual();
  });

  // ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
  loginBtn.addEventListener('click', async () => {
    const val = tokenInput.value.trim();
    if (!val) {
      loginError.textContent = 'í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
      return;
    }
    token = val;
    loginError.textContent = '';
    try {
      await loadManual();
    } catch (e) {
      loginError.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + e.message;
      token = '';
    }
  });

  // ë¡œê·¸ì•„ì›ƒ (ìƒˆë¡œê³ ì¹¨)
  logoutBtn.addEventListener('click', () => {
    token = '';
    fileSha = null;
    pages = {};
    currentKey = null;
    editor.textContent = '';
    pageList.innerHTML = '';
    pageTitle.textContent = '';
    app.style.display = 'none';
    loginOverlay.style.display = 'flex';
    tokenInput.value = '';
    loginError.textContent = '';
  });

  // ì´ˆê¸° ì§„ì…ì‹œ í† í° ì…ë ¥ ì°½ ë³´ì—¬ì¤Œ
  loginOverlay.style.display = 'flex';
  app.style.display = 'none';

})();
</script>

</body>
</html>
