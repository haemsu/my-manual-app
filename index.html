<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>내 매뉴얼</title>
  <style>
    body {
      margin: 0; font-family: sans-serif; display: flex; height: 100vh;
    }
    #loginOverlay {
      position: fixed; z-index: 10; background: #fff; top: 0; left: 0; right: 0; bottom: 0;
      display: flex; align-items: center; justify-content: center; flex-direction: column;
    }
    #app { flex: 1; display: flex; display: none; }
    #sidebar {
      width: 200px; background: #f5f5f5; padding: 10px; overflow-y: auto; border-right: 1px solid #ccc;
    }
    #editorArea {
      flex: 1; display: flex; flex-direction: column; padding: 10px;
    }
    #editorWrapper { flex: 1; border: 1px solid #ccc; margin-top: 10px; }
    #editor { height: 100%; }
    ul { list-style: none; padding: 0; }
    li.active { font-weight: bold; }
    button { margin: 5px 0; }
    #viewMode { border: 1px solid #ccc; padding: 10px; overflow-y: auto; flex: 1; }
    #editorControls { display: flex; gap: 10px; margin-top: 10px; }
  </style>
</head>
<body>
  <div id="loginOverlay">
    <h2>GitHub 토큰을 입력하세요</h2>
    <input id="tokenInput" placeholder="GitHub Personal Access Token" size="50">
    <button id="loginBtn">로그인</button>
    <div id="loginError" style="color:red;"></div>
  </div>

  <div id="app">
    <div id="sidebar">
      <button id="addPageBtn">+ 새 항목</button>
      <ul id="pageList"></ul>
    </div>
    <div id="editorArea">
      <h2 id="pageTitle">매뉴얼</h2>
      <div id="viewMode"></div>
      <div id="editorControls">
        <button id="editBtn">수정</button>
        <button id="saveBtn" style="display:none;">저장</button>
      </div>
      <div id="editorWrapper" style="display:none;">
        <textarea id="editor"></textarea>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
  <script>
    let token = '';
    let repo = 'my-manual-app';
    let owner = 'haemsu';
    let path = 'data/manual.json';
    let fileSha = null;
    let pages = {};
    let currentKey = null;

    const loginOverlay = document.getElementById('loginOverlay');
    const app = document.getElementById('app');
    const loginBtn = document.getElementById('loginBtn');
    const tokenInput = document.getElementById('tokenInput');
    const loginError = document.getElementById('loginError');
    const pageList = document.getElementById('pageList');
    const pageTitle = document.getElementById('pageTitle');
    const viewMode = document.getElementById('viewMode');
    const editor = document.getElementById('editor');
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    const editorWrapper = document.getElementById('editorWrapper');

    const converter = new showdown.Converter();

    async function githubRequest(method, url, body = null) {
      const res = await fetch(url, {
        method,
        headers: {
          'Authorization': 'token ' + token,
          'Accept': 'application/vnd.github.v3+json',
        },
        body: body ? JSON.stringify(body) : null
      });
      if (!res.ok) throw new Error((await res.json()).message || 'GitHub API 오류');
      return res.json();
    }

    async function loadManual() {
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
      const res = await githubRequest('GET', url);
      fileSha = res.sha;
      const content = atob(res.content);
      pages = JSON.parse(content);
      renderPageList();
      loginOverlay.style.display = 'none';
      app.style.display = 'flex';
    }

    async function saveManual() {
      const content = btoa(unescape(encodeURIComponent(JSON.stringify(pages, null, 2))));
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
      const res = await githubRequest('PUT', url, {
        message: '매뉴얼 업데이트',
        content,
        sha: fileSha,
      });
      fileSha = res.content.sha;
    }

    function renderPageList() {
      pageList.innerHTML = '';
      for (const key in pages) {
        const li = document.createElement('li');
        li.textContent = key;
        li.addEventListener('click', () => {
          currentKey = key;
          renderCurrentPage();
        });
        li.addEventListener('contextmenu', e => {
          e.preventDefault();
          const newName = prompt('이름 수정 또는 삭제하려면 빈칸으로 두세요:', key);
          if (newName === null) return;
          if (newName === '') {
            delete pages[key];
            if (currentKey === key) currentKey = null;
          } else {
            pages[newName] = pages[key];
            delete pages[key];
            currentKey = newName;
          }
          renderPageList();
          renderCurrentPage();
          saveManual();
        });
        if (key === currentKey) li.classList.add('active');
        pageList.appendChild(li);
      }
    }

    function renderCurrentPage() {
      if (!currentKey || !pages[currentKey]) {
        viewMode.innerHTML = '';
        editorWrapper.style.display = 'none';
        editBtn.style.display = 'none';
        saveBtn.style.display = 'none';
        pageTitle.textContent = '매뉴얼';
        return;
      }
      pageTitle.textContent = currentKey;
      viewMode.innerHTML = converter.makeHtml(pages[currentKey]);
      editBtn.style.display = 'inline-block';
      editorWrapper.style.display = 'none';
      saveBtn.style.display = 'none';
    }

    document.getElementById('addPageBtn').addEventListener('click', () => {
      const name = prompt('새 항목 이름:');
      if (!name || pages[name]) return;
      pages[name] = '';
      currentKey = name;
      renderPageList();
      renderCurrentPage();
      saveManual();
    });

    editBtn.addEventListener('click', () => {
      editor.value = pages[currentKey];
      editorWrapper.style.display = 'block';
      saveBtn.style.display = 'inline-block';
      editBtn.style.display = 'none';
    });

    saveBtn.addEventListener('click', () => {
      pages[currentKey] = editor.value;
      renderCurrentPage();
      renderPageList();
      saveManual();
    });

    loginBtn.addEventListener('click', () => {
      token = tokenInput.value.trim();
      if (!token) return;
      loadManual().catch(err => loginError.textContent = '에러: ' + err.message);
    });
  </script>
</body>
</html>
